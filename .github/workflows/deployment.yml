# 文件路径 .github/workflows/deployment.yml
name: Deployment

on:
  push:
    branches: [hexo] # only push events on source branch trigger deployment

jobs:
  hexo-deployment:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
    - name: Checkout source
      uses: actions/checkout@v2
      with:
        submodules: true

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.11'

    - name: Run convert.py
      run: python convert.py

    - name: Setup Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '16.x'

    - name: Install dependencies & Generate static files_
      run: |
        node -v
        npm i -g hexo-cli
        npm i

        # --- Start of Magic Script ---
        echo "Restructuring asset folders for Hexo..."
        # 遍历所有年月文件夹 (例如 source/_posts/2023-09/)
        for month_dir in source/_posts/*/ ; do
          # 如果该目录下存在 assets 文件夹
          if [ -d "${month_dir}assets" ]; then
            echo "Processing assets in ${month_dir}"
            # 将 assets 文件夹里的所有内容 (即各个文章名文件夹) 移动到上一层 (年月) 目录
            mv "${month_dir}assets"/* "${month_dir}"
            # 删除现在已经空了的 assets 文件夹
            rmdir "${month_dir}assets"
          fi
        done
        echo "Asset folder restructuring complete."
        # --- End of Magic Script ---

        hexo clean
        hexo g

    - name: Deploy to Github Pages
      env:
        GIT_NAME: Cx330-502
        GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
        REPO: github.com/Cx330-502/Cx330-502-Blogs
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        cd ./public && touch CNAME && echo 'diary.cx330-502.top' > CNAME
        git init && git add .
        git config --global user.name $GIT_NAME
        git config --global user.email $GIT_EMAIL
        git commit -m "Site deployed by GitHub Actions"
        git push --force --quiet "https://$GH_TOKEN@$REPO" master:master